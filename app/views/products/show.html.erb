<!DOCTYPE html>
<html lang="en">
<head>
  <title>Product Show Page</title>
  <meta name="csrf-token" content="<%= form_authenticity_token %>">
</head>
<body>
<h1>Product show page</h1>
<div class="flex justify-center gap-20 py-10">
  <div class="flex flex-wrap max-w-lg">
    <% @product.images.each do |image| %>
      <%= image_tag image, class: "w-auto h-64" %>
    <% end %>
  </div>

  <div class="min-h-screen flex flex-col items-start max-w-sm">
    <h1 class="font-bold text-4xl uppercase"><%= @product.name %></h1>
    <p class="text-2xl mt-4">$<%= (@product.price / 100.0).to_s %></p>
    <p class="text-md py-8"><%= @product.description %></p>
    <div class="my-8">
      <p class='uppercase text-lg'>Size</p>
      <% @product.stocks.each do |stock| %>
        <% if stock.amount > 0 %>
          <button value="<%= stock.size %>" class="size-button bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-opacity-50">
            <%= stock.size %>
          </button>
        <% else %>
          <button disabled value="<%= stock.size %>" class="disabled:bg-gray-400 bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-opacity-50">
            <%= stock.size %>
          </button>
        <% end %>
      <% end %>
    </div>
    <div id="selected-size"></div>
    <button id="add-to-cart" class="inline-flex items-center justify-center px-5 py-3 border border-transparent font-medium rounded-md text-white bg-gray-600 hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500">
      Add To Cart
    </button>
  </div>
</div>
<script>
    document.addEventListener('DOMContentLoaded', () => {
        let selectedSize = null;
        const sizeButtons = document.querySelectorAll('.size-button');
        const selectedSizeEl = document.getElementById('selected-size');
        const addToCartButton = document.getElementById('add-to-cart');
        const cartCount = document.getElementById('cart-count');

        function updateCartCount() {
            const cart = JSON.parse(localStorage.getItem('cart')) || [];
            let cartItemCount = cart.reduce((total, item) => total + item.quantity, 0);
            cartCount.innerText = cartItemCount;
        }

        sizeButtons.forEach(button => {
            button.addEventListener('click', (e) => {
                selectedSize = e.target.value;
                selectedSizeEl.innerText = `Selected Size: ${selectedSize}`;
            });
        });

        addToCartButton.addEventListener('click', () => {
            const product = {
                id: "<%= @product.id %>",
                name: "<%= @product.name %>",
                price: <%= @product.price %>,
                size: selectedSize,
                quantity: 1
            };

            if (!selectedSize) {
                alert("Please select a size");
                return;
            }

            let cart = localStorage.getItem('cart');
            if (cart) {
                const cartArray = JSON.parse(cart);
                const foundIndex = cartArray.findIndex(item => item.id === product.id && item.size === product.size);
                if (foundIndex >= 0) {
                    cartArray[foundIndex].quantity += 1;
                } else {
                    cartArray.push(product);
                }
                localStorage.setItem('cart', JSON.stringify(cartArray));
            } else {
                const cartArray = [product];
                localStorage.setItem('cart', JSON.stringify(cartArray));
            }

            updateCartCount();

            alert("Product added to cart");
        });

    });
</script>

</body>
</html>
